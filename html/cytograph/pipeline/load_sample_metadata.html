<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.8.4" />
<title>cytograph.pipeline.load_sample_metadata API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>cytograph.pipeline.load_sample_metadata</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from typing import List
import shoji
from .config import Config
import logging
import sys
import sqlite3 as sqlite
import os
import numpy as np
from cytograph import Algorithm
import pandas as pd


# Here&#39;s what was in the db on 2020-12-07 for 10X101_1:
#
# Id 411 &lt;class &#39;int&#39;&gt;
# Name 10X101_1 &lt;class &#39;str&#39;&gt;
# Shortname XHU:1405:297_Cortex &lt;class &#39;str&#39;&gt;
# Label  &lt;class &#39;str&#39;&gt;
# Method rna-seq &lt;class &#39;str&#39;&gt;
# Project Dev human &lt;class &#39;str&#39;&gt;
# Donor XHU:1405:297 &lt;class &#39;str&#39;&gt;
# Species Hs &lt;class &#39;str&#39;&gt;
# Strain  &lt;class &#39;str&#39;&gt;
# Age 10.0 &lt;class &#39;float&#39;&gt;
# Ageunit pcw &lt;class &#39;str&#39;&gt;
# Agetext 10w &lt;class &#39;str&#39;&gt;
# Sex  &lt;class &#39;str&#39;&gt;
# Numpooledanimals  &lt;class &#39;str&#39;&gt;
# Plugdate  &lt;class &#39;str&#39;&gt;
# Tissue Cortex &lt;class &#39;str&#39;&gt;
# Roi  &lt;class &#39;str&#39;&gt;
# Neuronprop N/A &lt;class &#39;str&#39;&gt;
# Targetnumcells 5000 &lt;class &#39;int&#39;&gt;
# Cellconc 1130 &lt;class &#39;int&#39;&gt;
# Datecaptured 2018-03-29 &lt;class &#39;str&#39;&gt;
# Sampleok Y &lt;class &#39;str&#39;&gt;
# Chemistry v2 &lt;class &#39;str&#39;&gt;
# Transcriptome GRCh38-3.0.0 &lt;class &#39;str&#39;&gt;
# Comment  &lt;class &#39;str&#39;&gt;
# Analysis Ready (10X101_1_GRCh38-3_0_0) &lt;class &#39;str&#39;&gt;
# All_fc_analysis_id 1429 &lt;class &#39;int&#39;&gt;
# Editby emelie &lt;class &#39;str&#39;&gt;
# Editat 2019-05-30 16:52:20 &lt;class &#39;str&#39;&gt;

class LoadSampleMetadata(Algorithm):
        &#34;&#34;&#34;
        Load samples metadata from a sqlite database
        &#34;&#34;&#34;
        def __init__(self, db: str, tensors: List[str], convert_10x_sample_name: bool = True, **kwargs) -&gt; None:
                &#34;&#34;&#34;
                Load samples metadata from a sqlite database
        
                Args:
                        db                              Full path to the metadata database file (a sqlite .db file)
                        tensors                 List of tensors to be created (or overwritten) from metadata
                        convert_10x_sample_name         If true, convert &#34;10X101_2&#34; to &#34;TenX101_2&#34;
                &#34;&#34;&#34;
                super().__init__(**kwargs)

                self.db = db
                if not os.path.exists(db):
                        logging.error(f&#34;Samples metadata file &#39;{db}&#39; not found&#34;)
                        sys.exit(1)
                self.tensors = tensors
                self.convert_10x_sample_name = convert_10x_sample_name

        def fit(self, ws: shoji.WorkspaceManager, save: bool = False) -&gt; None:
                db = shoji.connect()
                config = Config.load()
                punchcard = config.punchcard
                assert punchcard is not None
                missing = False
                samples_ws = db[config.workspaces.samples_workspace_name]
                for source in punchcard.sources:
                        if source not in samples_ws:
                                logging.error(f&#34;Sample {source} not found!&#34;)
                                missing = True
                if missing:
                        sys.exit(1)
                for source in punchcard.sources:
                        if source in samples_ws:
                                source_ws = samples_ws[source]
                        else:
                                logging.error(f&#34;Sample {source} not found!&#34;)
                                sys.exit(1)
                        logging.info(f&#34; LoadSampleMetadata: Updating metadata for &#39;{source}&#39;&#34;)
                        if self.convert_10x_sample_name and source.startswith(&#34;TenX&#34;):
                                sample_id = &#34;10X&#34; + source[4:]
                        else:
                                sample_id = source
                        if self.db.endswith(&#34;.db&#34;):
                                with sqlite.connect(self.db) as sqldb:
                                        cursor = sqldb.cursor()
                                        cursor.execute(&#34;SELECT * FROM sample WHERE name = ? COLLATE NOCASE&#34;, (sample_id,))
                                        keys = [x[0].lower() for x in cursor.description]
                                        vals = cursor.fetchone()
                                        if vals is None:
                                                logging.warning(f&#34;Sample &#39;{sample_id}&#39; not found in database&#34;)
                                        else:
                                                d = dict(zip(keys, vals))
                                                for tensor in self.tensors:
                                                        if tensor.lower() not in d:
                                                                logging.error(f&#34;Tensor &#39;{tensor}&#39; was not found in the metadata&#34;)
                                                                sys.exit(1)
                                                        val = d[tensor.lower()]
                                                        if isinstance(val, int):
                                                                source_ws[tensor] = shoji.Tensor(&#34;int32&#34;, (), inits=np.array(val, dtype=&#34;int32&#34;))
                                                        elif isinstance(val, float):
                                                                source_ws[tensor] = shoji.Tensor(&#34;float32&#34;, (), inits=np.array(val, dtype=&#34;float32&#34;))
                                                        elif isinstance(val, str):
                                                                source_ws[tensor] = shoji.Tensor(&#34;string&#34;, (), inits=np.array(val, dtype=object))
                        elif self.db.endswith(&#34;.xlsx&#34;):
                                table = pd.read_excel(self.db)
                                row = table[table[&#34;SampleID&#34;] == sample_id]
                                keys = row.columns.values
                                vals = row.values[0]
                                d = dict(zip(keys, vals))
                                for tensor in self.tensors:
                                        if tensor not in d:
                                                logging.error(f&#34;Tensor &#39;{tensor}&#39; was not found in the metadata&#34;)
                                                sys.exit(1)
                                        val = d[tensor]
                                        if isinstance(val, int):
                                                source_ws[tensor] = shoji.Tensor(&#34;int32&#34;, (), inits=np.array(val, dtype=&#34;int32&#34;))
                                        elif isinstance(val, float):
                                                source_ws[tensor] = shoji.Tensor(&#34;float32&#34;, (), inits=np.array(val, dtype=&#34;float32&#34;))
                                        elif isinstance(val, str):
                                                source_ws[tensor] = shoji.Tensor(&#34;string&#34;, (), inits=np.array(val, dtype=object))
                                        else:
                                                logging.error(f&#34;Invalid datatype &#39;{type(val)}&#39; for &#39;{tensor}&#39;&#34;)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="cytograph.pipeline.load_sample_metadata.LoadSampleMetadata"><code class="flex name class">
<span>class <span class="ident">LoadSampleMetadata</span></span>
<span>(</span><span>db: str, tensors: List[str], convert_10x_sample_name: bool = True, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"><p>Load samples metadata from a sqlite database</p>
<p>Load samples metadata from a sqlite database</p>
<h2 id="args">Args</h2>
<p>db
Full path to the metadata database file (a sqlite .db file)
tensors
List of tensors to be created (or overwritten) from metadata
convert_10x_sample_name
If true, convert "10X101_2" to "TenX101_2"</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class LoadSampleMetadata(Algorithm):
        &#34;&#34;&#34;
        Load samples metadata from a sqlite database
        &#34;&#34;&#34;
        def __init__(self, db: str, tensors: List[str], convert_10x_sample_name: bool = True, **kwargs) -&gt; None:
                &#34;&#34;&#34;
                Load samples metadata from a sqlite database
        
                Args:
                        db                              Full path to the metadata database file (a sqlite .db file)
                        tensors                 List of tensors to be created (or overwritten) from metadata
                        convert_10x_sample_name         If true, convert &#34;10X101_2&#34; to &#34;TenX101_2&#34;
                &#34;&#34;&#34;
                super().__init__(**kwargs)

                self.db = db
                if not os.path.exists(db):
                        logging.error(f&#34;Samples metadata file &#39;{db}&#39; not found&#34;)
                        sys.exit(1)
                self.tensors = tensors
                self.convert_10x_sample_name = convert_10x_sample_name

        def fit(self, ws: shoji.WorkspaceManager, save: bool = False) -&gt; None:
                db = shoji.connect()
                config = Config.load()
                punchcard = config.punchcard
                assert punchcard is not None
                missing = False
                samples_ws = db[config.workspaces.samples_workspace_name]
                for source in punchcard.sources:
                        if source not in samples_ws:
                                logging.error(f&#34;Sample {source} not found!&#34;)
                                missing = True
                if missing:
                        sys.exit(1)
                for source in punchcard.sources:
                        if source in samples_ws:
                                source_ws = samples_ws[source]
                        else:
                                logging.error(f&#34;Sample {source} not found!&#34;)
                                sys.exit(1)
                        logging.info(f&#34; LoadSampleMetadata: Updating metadata for &#39;{source}&#39;&#34;)
                        if self.convert_10x_sample_name and source.startswith(&#34;TenX&#34;):
                                sample_id = &#34;10X&#34; + source[4:]
                        else:
                                sample_id = source
                        if self.db.endswith(&#34;.db&#34;):
                                with sqlite.connect(self.db) as sqldb:
                                        cursor = sqldb.cursor()
                                        cursor.execute(&#34;SELECT * FROM sample WHERE name = ? COLLATE NOCASE&#34;, (sample_id,))
                                        keys = [x[0].lower() for x in cursor.description]
                                        vals = cursor.fetchone()
                                        if vals is None:
                                                logging.warning(f&#34;Sample &#39;{sample_id}&#39; not found in database&#34;)
                                        else:
                                                d = dict(zip(keys, vals))
                                                for tensor in self.tensors:
                                                        if tensor.lower() not in d:
                                                                logging.error(f&#34;Tensor &#39;{tensor}&#39; was not found in the metadata&#34;)
                                                                sys.exit(1)
                                                        val = d[tensor.lower()]
                                                        if isinstance(val, int):
                                                                source_ws[tensor] = shoji.Tensor(&#34;int32&#34;, (), inits=np.array(val, dtype=&#34;int32&#34;))
                                                        elif isinstance(val, float):
                                                                source_ws[tensor] = shoji.Tensor(&#34;float32&#34;, (), inits=np.array(val, dtype=&#34;float32&#34;))
                                                        elif isinstance(val, str):
                                                                source_ws[tensor] = shoji.Tensor(&#34;string&#34;, (), inits=np.array(val, dtype=object))
                        elif self.db.endswith(&#34;.xlsx&#34;):
                                table = pd.read_excel(self.db)
                                row = table[table[&#34;SampleID&#34;] == sample_id]
                                keys = row.columns.values
                                vals = row.values[0]
                                d = dict(zip(keys, vals))
                                for tensor in self.tensors:
                                        if tensor not in d:
                                                logging.error(f&#34;Tensor &#39;{tensor}&#39; was not found in the metadata&#34;)
                                                sys.exit(1)
                                        val = d[tensor]
                                        if isinstance(val, int):
                                                source_ws[tensor] = shoji.Tensor(&#34;int32&#34;, (), inits=np.array(val, dtype=&#34;int32&#34;))
                                        elif isinstance(val, float):
                                                source_ws[tensor] = shoji.Tensor(&#34;float32&#34;, (), inits=np.array(val, dtype=&#34;float32&#34;))
                                        elif isinstance(val, str):
                                                source_ws[tensor] = shoji.Tensor(&#34;string&#34;, (), inits=np.array(val, dtype=object))
                                        else:
                                                logging.error(f&#34;Invalid datatype &#39;{type(val)}&#39; for &#39;{tensor}&#39;&#34;)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="cytograph.algorithm.Algorithm" href="../algorithm.html#cytograph.algorithm.Algorithm">Algorithm</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="cytograph.pipeline.load_sample_metadata.LoadSampleMetadata.fit"><code class="name flex">
<span>def <span class="ident">fit</span></span>(<span>self, ws: shoji.workspace.WorkspaceManager, save: bool = False) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def fit(self, ws: shoji.WorkspaceManager, save: bool = False) -&gt; None:
        db = shoji.connect()
        config = Config.load()
        punchcard = config.punchcard
        assert punchcard is not None
        missing = False
        samples_ws = db[config.workspaces.samples_workspace_name]
        for source in punchcard.sources:
                if source not in samples_ws:
                        logging.error(f&#34;Sample {source} not found!&#34;)
                        missing = True
        if missing:
                sys.exit(1)
        for source in punchcard.sources:
                if source in samples_ws:
                        source_ws = samples_ws[source]
                else:
                        logging.error(f&#34;Sample {source} not found!&#34;)
                        sys.exit(1)
                logging.info(f&#34; LoadSampleMetadata: Updating metadata for &#39;{source}&#39;&#34;)
                if self.convert_10x_sample_name and source.startswith(&#34;TenX&#34;):
                        sample_id = &#34;10X&#34; + source[4:]
                else:
                        sample_id = source
                if self.db.endswith(&#34;.db&#34;):
                        with sqlite.connect(self.db) as sqldb:
                                cursor = sqldb.cursor()
                                cursor.execute(&#34;SELECT * FROM sample WHERE name = ? COLLATE NOCASE&#34;, (sample_id,))
                                keys = [x[0].lower() for x in cursor.description]
                                vals = cursor.fetchone()
                                if vals is None:
                                        logging.warning(f&#34;Sample &#39;{sample_id}&#39; not found in database&#34;)
                                else:
                                        d = dict(zip(keys, vals))
                                        for tensor in self.tensors:
                                                if tensor.lower() not in d:
                                                        logging.error(f&#34;Tensor &#39;{tensor}&#39; was not found in the metadata&#34;)
                                                        sys.exit(1)
                                                val = d[tensor.lower()]
                                                if isinstance(val, int):
                                                        source_ws[tensor] = shoji.Tensor(&#34;int32&#34;, (), inits=np.array(val, dtype=&#34;int32&#34;))
                                                elif isinstance(val, float):
                                                        source_ws[tensor] = shoji.Tensor(&#34;float32&#34;, (), inits=np.array(val, dtype=&#34;float32&#34;))
                                                elif isinstance(val, str):
                                                        source_ws[tensor] = shoji.Tensor(&#34;string&#34;, (), inits=np.array(val, dtype=object))
                elif self.db.endswith(&#34;.xlsx&#34;):
                        table = pd.read_excel(self.db)
                        row = table[table[&#34;SampleID&#34;] == sample_id]
                        keys = row.columns.values
                        vals = row.values[0]
                        d = dict(zip(keys, vals))
                        for tensor in self.tensors:
                                if tensor not in d:
                                        logging.error(f&#34;Tensor &#39;{tensor}&#39; was not found in the metadata&#34;)
                                        sys.exit(1)
                                val = d[tensor]
                                if isinstance(val, int):
                                        source_ws[tensor] = shoji.Tensor(&#34;int32&#34;, (), inits=np.array(val, dtype=&#34;int32&#34;))
                                elif isinstance(val, float):
                                        source_ws[tensor] = shoji.Tensor(&#34;float32&#34;, (), inits=np.array(val, dtype=&#34;float32&#34;))
                                elif isinstance(val, str):
                                        source_ws[tensor] = shoji.Tensor(&#34;string&#34;, (), inits=np.array(val, dtype=object))
                                else:
                                        logging.error(f&#34;Invalid datatype &#39;{type(val)}&#39; for &#39;{tensor}&#39;&#34;)</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="cytograph.pipeline" href="index.html">cytograph.pipeline</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="cytograph.pipeline.load_sample_metadata.LoadSampleMetadata" href="#cytograph.pipeline.load_sample_metadata.LoadSampleMetadata">LoadSampleMetadata</a></code></h4>
<ul class="">
<li><code><a title="cytograph.pipeline.load_sample_metadata.LoadSampleMetadata.fit" href="#cytograph.pipeline.load_sample_metadata.LoadSampleMetadata.fit">fit</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.8.4</a>.</p>
</footer>
</body>
</html>